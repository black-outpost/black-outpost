<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid-Based Skill Tree Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(20,20,30,0.9) 100%);
            min-height: 100vh;
            color: #e0e6ed;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .nav-bar {
            background: linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.8) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.5px;
        }

        .nav-title::before {
            content: "🌳";
            color: #10b981;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.8) 0%, rgba(51, 65, 85, 0.9) 100%);
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: 'JetBrains Mono', monospace;
        }

        .btn:hover {
            background: linear-gradient(135deg, rgba(71, 85, 105, 1) 0%, rgba(51, 65, 85, 1) 100%);
            border-color: rgba(148, 163, 184, 0.4);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.9) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8) 0%, rgba(5, 150, 105, 0.9) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .sidebar, .properties-panel {
            background: linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.8) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        .sidebar-header, .panel-header {
            background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(51,65,85,0.8) 100%);
            padding: 16px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.4);
        }

        .sidebar-title, .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            letter-spacing: 0.5px;
        }

        .tree-selector {
            padding: 16px;
        }

        .tree-tabs {
            display: grid;
            gap: 8px;
        }

        .tree-tab {
            background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(51,65,85,0.4) 100%);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: #94a3b8;
        }

        .tree-tab:hover {
            border-color: rgba(148, 163, 184, 0.5);
            color: #e2e8f0;
        }

        .tree-tab.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.5);
            color: #10b981;
        }

        .node-palette {
            padding: 16px;
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .palette-section {
            margin-bottom: 20px;
        }

        .palette-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .node-templates {
            display: grid;
            gap: 8px;
        }

        .node-template {
            background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(51,65,85,0.4) 100%);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .node-template:hover {
            border-color: rgba(148, 163, 184, 0.5);
            transform: translateY(-1px);
        }

        .canvas-container {
            background: linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.8) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .canvas-header {
            background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(51,65,85,0.8) 100%);
            padding: 16px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .canvas-tools {
            display: flex;
            gap: 8px;
        }

        .tool-btn {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.6) 0%, rgba(51, 65, 85, 0.7) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #94a3b8;
        }

        .tool-btn:hover {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.8) 0%, rgba(51, 65, 85, 0.9) 100%);
            color: #e2e8f0;
        }

        .tool-btn.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.5);
            color: #10b981;
        }

        .tree-canvas {
            position: relative;
            width: 100%;
            height: calc(100% - 60px);
            overflow: auto;
        }

        .tier-container {
            position: relative;
            width: 100%;
            min-height: 100%;
            padding: 20px;
        }

        .tier-section {
            position: relative;
            width: 100%;
            height: 500px;
            border-bottom: 2px dashed rgba(148, 163, 184, 0.3);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tier-content {
            position: relative;
            width: 550px;
            height: 500px;
        }

        .tier-header {
            position: absolute;
            top: 10px;
            left: 20px;
            background: linear-gradient(135deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.8) 100%);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #f1f5f9;
            border: 1px solid rgba(71, 85, 105, 0.3);
            z-index: 5;
        }

        /* Grid system */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.5;
            z-index: 1;
        }

        .grid-cell {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-sizing: border-box;
        }

        .grid-cell.occupied {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* Node styles */
        .skill-node {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
            z-index: 10;
            border-radius: 8px;
        }

        .skill-node.selected {
            filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.6));
            z-index: 15;
        }

        .skill-node.dragging {
            z-index: 20;
            transform: scale(1.05);
        }

        .node-small {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.8) 0%, rgba(5, 150, 105, 0.9) 100%);
            border: 2px solid #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .node-medium-rect {
            width: 100px;
            height: 50px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.8) 0%, rgba(217, 119, 6, 0.9) 100%);
            border: 2px solid #f59e0b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            color: #f1f5f9;
            text-align: center;
            padding: 4px;
        }

        .node-large-circle {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.9) 100%);
            border: 3px solid #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            font-weight: 500;
            color: #f1f5f9;
            text-align: center;
            padding: 8px;
        }

        .node-large-rect {
            width: 200px;
            height: 50px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.8) 0%, rgba(124, 58, 237, 0.9) 100%);
            border: 2px solid #8b5cf6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            color: #f1f5f9;
            text-align: center;
            padding: 4px 8px;
        }

        .starter-node {
            border: 3px solid #f59e0b !important;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 1) 100%) !important;
        }

        .starter-node::after {
            content: "★";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
            color: #fbbf24;
        }

        .properties-content {
            padding: 16px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            z-index: 1001;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .success-message {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.9) 0%, rgba(16, 185, 129, 0.8) 100%);
            color: #a7f3d0;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, rgba(153, 27, 27, 0.9) 0%, rgba(127, 29, 29, 0.8) 100%);
            color: #fecaca;
            border-color: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <div class="nav-title">
                SKILL TREE EDITOR
            </div>
            <div class="nav-actions">
                <button class="btn" onclick="exportTree()">EXPORT</button>
                <button class="btn" onclick="importTree()">IMPORT</button>
                <button class="btn btn-success" onclick="saveTree()">SAVE TREE</button>
                <a href="admin-dashboard.html" class="btn" id="backToDashboard">DASHBOARD</a>
                <a href="index.html" class="btn btn-danger" onclick="logout()">LOGOUT</a>
            </div>
        </nav>

        <div class="editor-layout">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">SKILL TREES</div>
                </div>
                <div class="tree-selector">
                    <div class="tree-tabs" id="treeTabs">
                        <div class="tree-tab active" data-tree="strength">STRENGTH</div>
                        <div class="tree-tab" data-tree="vitality">VITALITY</div>
                        <div class="tree-tab" data-tree="speed">SPEED</div>
                        <div class="tree-tab" data-tree="defense">DEFENSE</div>
                        <div class="tree-tab" data-tree="reiatsu">REIATSU</div>
                        <div class="tree-tab" data-tree="hakuda">HAKUDA</div>
                        <div class="tree-tab" data-tree="weaponship">WEAPONSHIP</div>
                        <div class="tree-tab" data-tree="tamashi">TAMASHI</div>
                        <div class="tree-tab" data-tree="magic">MAGIC</div>
                        <div class="tree-tab" data-tree="nazo">NAZO</div>
                    </div>
                </div>
                <div class="node-palette">
                    <div class="palette-section">
                        <div class="palette-title">Node Types</div>
                        <div class="node-templates">
                            <div class="node-template" onclick="addNode('small', 1)">
                                <span style="color: #10b981;">●</span>
                                Small Node (1x1)
                            </div>
                            <div class="node-template" onclick="addNode('medium-rect', 2)">
                                <span style="color: #f59e0b;">▬</span>
                                Med Rect (2x1)
                            </div>
                            <div class="node-template" onclick="addNode('large-circle', 4)">
                                <span style="color: #ef4444;">◯</span>
                                Large Circle (2x2)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="canvas-container">
                <div class="canvas-header">
                    <div class="canvas-title" id="canvasTitle">STRENGTH TREE</div>
                    <div class="canvas-tools">
                        <button class="tool-btn" onclick="addTier()">ADD TIER</button>
                        <button class="tool-btn" onclick="resetTree()">RESET</button>
                    </div>
                </div>
                <div class="tree-canvas">
                    <div class="tier-container" id="tierContainer">
                        <!-- Content will be generated here -->
                    </div>
                </div>
            </div>

            <div class="properties-panel">
                <div class="panel-header">
                    <div class="panel-title">NODE PROPERTIES</div>
                </div>
                <div class="properties-content" id="propertiesContent">
                    <div style="text-align: center; color: #64748b; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-top: 40px;">
                        SELECT A NODE TO EDIT
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBurBHVh1tNQ5LdPPYEaynkiwm_nJQbM7o",
            authDomain: "bleach-black-outpost.firebaseapp.com",
            projectId: "bleach-black-outpost",
            storageBucket: "bleach-black-outpost.firebasestorage.app",
            messagingSenderId: "201204368777",
            appId: "1:201204368777:web:c2a34d61acb46e7b494d58",
            measurementId: "G-SBD3766NQ6"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebase = { db, doc, getDoc, setDoc };
        window.firebaseReady = true;
    </script>

    <script>
        // Simple global variables
        let currentUser = null;
        let currentTree = 'strength';
        let treeData = { tiers: [] };
        let nodeCounter = 0;
        let selectedNode = null;

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded');
            const checkFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(checkFirebase);
                    loadUserData();
                }
            }, 100);
        });

        async function loadUserData() {
            const urlParams = new URLSearchParams(window.location.search);
            const login = urlParams.get('login') || localStorage.getItem('currentUser');
            
            if (login) {
                try {
                    const userDoc = await window.firebase.getDoc(window.firebase.doc(window.firebase.db, 'users', login));
                    if (userDoc.exists()) {
                        currentUser = { login, ...userDoc.data() };
                        if (currentUser.role === 'admin') {
                            document.getElementById('backToDashboard').href = `admin-dashboard.html?login=${login}`;
                            initializeBasicEditor();
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user:', error);
                }
            }
            
            initializeBasicEditor(); // Initialize even if user loading fails
        }

        function initializeBasicEditor() {
            console.log('Initializing basic editor');
            
            // Initialize tree with starter node
            treeData = {
                tiers: [{
                    tier: 1,
                    nodes: [{
                        id: 'starter_1',
                        type: 'small',
                        gridRow: 9,
                        gridCol: 5,
                        isStarter: true,
                        name: 'START',
                        size: 1
                    }]
                }]
            };
            
            setupTreeTabs();
            renderBasicTree();
        }

        function setupTreeTabs() {
            document.getElementById('treeTabs').addEventListener('click', function(e) {
                if (e.target.classList.contains('tree-tab')) {
                    switchTree(e.target.dataset.tree);
                }
            });
        }

        function switchTree(treeType) {
            currentTree = treeType;
            
            // Update active tab
            document.querySelectorAll('.tree-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tree="${treeType}"]`).classList.add('active');
            
            // Update canvas title
            document.getElementById('canvasTitle').textContent = treeType.toUpperCase() + ' TREE';
            
            // Reinitialize for new tree
            treeData = {
                tiers: [{
                    tier: 1,
                    nodes: [{
                        id: `starter_${treeType}`,
                        type: 'small',
                        gridRow: 9,
                        gridCol: 5,
                        isStarter: true,
                        name: 'START',
                        size: 1
                    }]
                }]
            };
            
            renderBasicTree();
            showMessage(`Switched to ${treeType.toUpperCase()} tree`);
        }

        function showMessage(message, type = 'success') {
            console.log(`${type}: ${message}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function addNode(nodeType, size) {
            console.log('Adding node:', nodeType, 'size:', size);
            
            nodeCounter++;
            const newNode = {
                id: `node_${nodeCounter}`,
                type: nodeType,
                gridRow: Math.floor(Math.random() * 8), // Avoid bottom row (starter)
                gridCol: Math.floor(Math.random() * 9), // Avoid center column
                name: `New ${nodeType} Node`,
                size: size
            };

            // Set default properties based on node type
            if (nodeType === 'small') {
                newNode.statBonus = '+1 STR';
            } else if (nodeType === 'medium-rect') {
                newNode.abilityName = 'New Ability';
                newNode.abilityDesc = 'Ability description goes here.';
            } else if (nodeType === 'large-circle') {
                newNode.abilityName = 'Major Ability';
                newNode.abilityDesc = 'Powerful ability with significant effects.';
            }
            
            // Find highest tier
            let targetTier = Math.max(...treeData.tiers.map(t => t.tier));
            let tier = treeData.tiers.find(t => t.tier === targetTier);
            
            if (!tier) {
                tier = { tier: 1, nodes: [] };
                treeData.tiers.push(tier);
            }
            
            tier.nodes.push(newNode);
            renderBasicTree();
            showMessage(`${nodeType} node added`);
        }

        function renderBasicTree() {
            console.log('Rendering tree');
            const container = document.getElementById('tierContainer');
            container.innerHTML = '';

            // Render each tier
            treeData.tiers.forEach(tier => {
                const tierDiv = document.createElement('div');
                tierDiv.className = 'tier-section';
                
                const tierContent = document.createElement('div');
                tierContent.className = 'tier-content';
                
                const header = document.createElement('div');
                header.className = 'tier-header';
                header.textContent = `TIER ${tier.tier}`;
                tierContent.appendChild(header);
                
                // Add grid
                const grid = document.createElement('div');
                grid.className = 'grid-overlay';
                for (let row = 0; row < 10; row++) {
                    for (let col = 0; col < 11; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.left = (col * 50) + 'px';
                        cell.style.top = (row * 50) + 'px';
                        grid.appendChild(cell);
                    }
                }
                tierContent.appendChild(grid);
                
                // Add nodes
                tier.nodes.forEach(node => {
                    const nodeDiv = document.createElement('div');
                    nodeDiv.className = `skill-node node-${node.type}`;
                    if (node.isStarter) nodeDiv.classList.add('starter-node');
                    
                    nodeDiv.style.left = (node.gridCol * 50) + 'px';
                    nodeDiv.style.top = (node.gridRow * 50) + 'px';
                    
                    // Set content based on node type and reference image format
                    if (node.isStarter) {
                        nodeDiv.textContent = 'START';
                    } else if (node.type === 'small') {
                        // Small stat nodes show stat bonus like "+1 STR", "+2 SPD"
                        const statBonus = node.statBonus || '+1 STR';
                        nodeDiv.textContent = statBonus;
                    } else if (node.type === 'medium-rect') {
                        // Medium rectangular ability nodes
                        const abilityName = node.abilityName || 'New Ability';
                        const abilityDesc = node.abilityDesc || 'Description of the ability effect and mechanics.';
                        
                        nodeDiv.innerHTML = `
                            <div class="ability-name">${abilityName}</div>
                            <div class="ability-desc">${abilityDesc}</div>
                        `;
                    } else if (node.type === 'large-circle') {
                        // Large circular major ability nodes  
                        const abilityName = node.abilityName || 'Major Ability';
                        const abilityDesc = node.abilityDesc || 'Powerful ability with significant impact on gameplay.';
                        
                        nodeDiv.innerHTML = `
                            <div class="ability-name">${abilityName}</div>
                            <div class="ability-desc">${abilityDesc}</div>
                        `;
                    }
                    
                    nodeDiv.dataset.nodeId = node.id;
                    nodeDiv.draggable = true;
                    
                    // Add click handler for selection
                    nodeDiv.onclick = function(e) {
                        selectNode(this);
                        e.stopPropagation();
                    };
                    
                    // Add drag handlers for movement
                    nodeDiv.ondragstart = function(e) {
                        this.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', node.id);
                    };
                    
                    nodeDiv.ondragend = function(e) {
                        this.classList.remove('dragging');
                    };
                    
                    tierContent.appendChild(nodeDiv);
                });
                
                // Add drop handler to tier content
                tierContent.ondragover = function(e) {
                    e.preventDefault();
                };
                
                tierContent.ondrop = function(e) {
                    e.preventDefault();
                    const nodeId = e.dataTransfer.getData('text/plain');
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const newCol = Math.floor(x / 50);
                    const newRow = Math.floor(y / 50);
                    
                    moveNodeToPosition(nodeId, tier.tier, newRow, newCol);
                };
                
                tierDiv.appendChild(tierContent);
                container.appendChild(tierDiv);
            });
        }

        function selectNode(nodeElement) {
            // Deselect all nodes
            document.querySelectorAll('.skill-node').forEach(node => {
                node.classList.remove('selected');
            });
            
            // Select this node
            nodeElement.classList.add('selected');
            selectedNode = nodeElement;
            
            showNodeProperties(nodeElement);
        }

        function showNodeProperties(nodeElement) {
            const content = document.getElementById('propertiesContent');
            const nodeId = nodeElement.dataset.nodeId;
            
            // Find node data
            let nodeData = null;
            for (let tier of treeData.tiers) {
                nodeData = tier.nodes.find(n => n.id === nodeId);
                if (nodeData) break;
            }
            
            if (!nodeData) return;
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase;">Node ID</label>
                    <input type="text" value="${nodeData.id}" readonly style="width: 100%; padding: 6px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.4); border-radius: 6px; color: #f1f5f9; font-size: 11px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase;">Type</label>
                    <input type="text" value="${nodeData.type}" readonly style="width: 100%; padding: 6px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.4); border-radius: 6px; color: #f1f5f9; font-size: 11px;">
                </div>
            `;

            // Show different properties based on node type
            if (nodeData.type === 'small' && !nodeData.isStarter) {
                html += `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase;">Stat Bonus</label>
                        <input type="text" value="${nodeData.statBonus || '+1 STR'}" onchange="updateNodeProperty('${nodeId}', 'statBonus', this.value)" placeholder="+1 STR" style="width: 100%; padding: 6px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.4); border-radius: 6px; color: #f1f5f9; font-size: 11px;">
                    </div>
                `;
            } else if (nodeData.type === 'medium-rect' || nodeData.type === 'large-circle') {
                html += `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase;">Ability Name</label>
                        <input type="text" value="${nodeData.abilityName || 'New Ability'}" onchange="updateNodeProperty('${nodeId}', 'abilityName', this.value)" style="width: 100%; padding: 6px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.4); border-radius: 6px; color: #f1f5f9; font-size: 11px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase;">Ability Description</label>
                        <textarea onchange="updateNodeProperty('${nodeId}', 'abilityDesc', this.value)" placeholder="Describe the ability effect..." style="width: 100%; padding: 6px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.4); border-radius: 6px; color: #f1f5f9; font-size: 11px; min-height: 60px; resize: vertical;">${nodeData.abilityDesc || 'Ability description goes here.'}</textarea>
                    </div>
                `;
            }

            if (!nodeData.isStarter) {
                html += `
                    <div style="margin-top: 20px;">
                        <button onclick="deleteNode('${nodeId}')" style="background: linear-gradient(135deg, rgba(239,68,68,0.8) 0%, rgba(220,38,38,0.9) 100%); color: #f1f5f9; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: 'JetBrains Mono', monospace;">DELETE NODE</button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function updateNodeProperty(nodeId, property, value) {
            for (let tier of treeData.tiers) {
                const node = tier.nodes.find(n => n.id === nodeId);
                if (node) {
                    node[property] = value;
                    renderBasicTree();
                    // Reselect the node to maintain selection after re-render
                    setTimeout(() => {
                        const nodeElement = document.querySelector(`[data-node-id="${nodeId}"]`);
                        if (nodeElement) {
                            selectNode(nodeElement);
                        }
                    }, 100);
                    break;
                }
            }
        }

        function deleteNode(nodeId) {
            if (confirm('Delete this node?')) {
                for (let tier of treeData.tiers) {
                    const nodeIndex = tier.nodes.findIndex(n => n.id === nodeId);
                    if (nodeIndex >= 0) {
                        tier.nodes.splice(nodeIndex, 1);
                        selectedNode = null;
                        renderBasicTree();
                        document.getElementById('propertiesContent').innerHTML = `
                            <div style="text-align: center; color: #64748b; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-top: 40px;">
                                SELECT A NODE TO EDIT
                            </div>
                        `;
                        showMessage('Node deleted');
                        break;
                    }
                }
            }
        }

        function moveNodeToPosition(nodeId, tierNum, newRow, newCol) {
            // Keep within bounds
            if (newRow < 0 || newRow >= 10 || newCol < 0 || newCol >= 11) return;
            
            // Don't allow moving to starter position
            if (newRow === 9 && newCol === 5) {
                showMessage('Cannot move to starter position', 'error');
                return;
            }
            
            for (let tier of treeData.tiers) {
                const node = tier.nodes.find(n => n.id === nodeId);
                if (node) {
                    node.gridRow = newRow;
                    node.gridCol = newCol;
                    renderBasicTree();
                    showMessage('Node moved');
                    break;
                }
            }
        }

        function addTier() {
            console.log('Adding tier');
            const maxTier = Math.max(...treeData.tiers.map(t => t.tier), 0);
            const newTier = {
                tier: maxTier + 1,
                nodes: []
            };
            treeData.tiers.push(newTier);
            renderBasicTree();
            showMessage(`Added Tier ${maxTier + 1}`);
        }

        function resetTree() {
            console.log('Resetting tree');
            if (confirm('Reset tree? This will delete all nodes except the starter.')) {
                treeData = {
                    tiers: [{
                        tier: 1,
                        nodes: [{
                            id: `starter_${currentTree}`,
                            type: 'small',
                            gridRow: 9,
                            gridCol: 5,
                            isStarter: true,
                            name: 'START',
                            size: 1
                        }]
                    }]
                };
                nodeCounter = 0;
                selectedNode = null;
                renderBasicTree();
                document.getElementById('propertiesContent').innerHTML = `
                    <div style="text-align: center; color: #64748b; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-top: 40px;">
                        SELECT A NODE TO EDIT
                    </div>
                `;
                showMessage('Tree reset');
            }
        }

        async function saveTree() {
            try {
                if (window.firebaseReady && window.firebase) {
                    const treeId = `${currentTree}_tree`;
                    await window.firebase.setDoc(
                        window.firebase.doc(window.firebase.db, 'skillTrees', treeId), 
                        treeData
                    );
                    showMessage('Tree saved');
                } else {
                    showMessage('Firebase not ready', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showMessage('Save failed', 'error');
            }
        }

        function exportTree() {
            const dataStr = JSON.stringify(treeData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `${currentTree}_tree.json`);
            link.click();
            showMessage('Tree exported');
        }

        function importTree() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            treeData = JSON.parse(e.target.result);
                            renderBasicTree();
                            showMessage('Tree imported');
                        } catch (error) {
                            showMessage('Invalid file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>